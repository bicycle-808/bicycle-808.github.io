<!DOCTYPE html><html lang="zh-CN" data-theme="light"><script>((function() {var callbacks = [],timeLimit = 50,open = false;setInterval(loop, 1);return {addListener: function(fn) {callbacks.push(fn);},cancleListenr: function(fn) {callbacks = callbacks.filter(function(v) {return v !== fn;});}}
function loop() {var startTime = new Date();debugger;if (new Date() - startTime > timeLimit) {if (!open) {callbacks.forEach(function(fn) {fn.call(null);});}open = true;window.stop();alert('本站点禁止打开控制台，请关闭。如有疑问请联系站长！(*^_^*)');document.body.innerHTML = "";} else {open = false;}}})()).addListener(function() {window.location.reload();});</script><script>function toDevtools(){
  let num = 0; 
  let devtools = new Date();
  devtools.toString = function() {
    num++;
    if (num > 1) {
        alert('本站点禁止打开控制台，请关闭。如有疑问请联系站长！(*^_^*)')
        window.location.href = "about:blank"
        blast();
    }
  }
  console.log('', devtools);
}
toDevtools();</script><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Tengbin 的技术博客</title><meta name="author" content="Tengbin Li"><meta name="copyright" content="Tengbin Li"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="大鹏一日同风起，扶摇直上九万里">
<meta property="og:type" content="website">
<meta property="og:title" content="Tengbin 的技术博客">
<meta property="og:url" content="https://www.litengbin.com/index.html">
<meta property="og:site_name" content="Tengbin 的技术博客">
<meta property="og:description" content="大鹏一日同风起，扶摇直上九万里">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/02043070889f024eeb02a51c42658b9.jpg">
<meta property="article:author" content="Tengbin Li">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/02043070889f024eeb02a51c42658b9.jpg"><link rel="shortcut icon" href="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/02043070889f024eeb02a51c42658b9.jpg"><link rel="canonical" href="https://www.litengbin.com/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Tengbin Li","link":"链接: ","source":"来源: Tengbin 的技术博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#6F42C1","position":"top-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Tengbin 的技术博客',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2023-08-23 15:04:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/my.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/02043070889f024eeb02a51c42658b9.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header" style="background-image: url('https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/1234jnfklhdue0944nj.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Tengbin 的技术博客"><span class="site-name">Tengbin 的技术博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Tengbin 的技术博客</h1><div id="site-subtitle"><span id="subtitle"></span></div><div id="site_social_icons"><a class="social-icon" href="https://github.com/bicycle-808" target="_blank" title="Github"><i class="fab fa-github" style="color: ;"></i></a><a class="social-icon" href="mailto:745075779@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: ;"></i></a><a class="social-icon" href="https://www.litengbin.com/static/wechat.jpg" target="_blank" title="微信"><i class="fab fa-weixin" style="color: ;"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/2023/07/26/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%20Tengbin_ACM%20%E4%BC%81%E4%B8%9A%E7%BA%A7%E4%B8%AD%E5%A4%AE%E9%85%8D%E7%BD%AE%E5%BC%95%E6%93%8E/" title="开源项目 Tengbin_ACM 企业级中央配置引擎"><img class="post-bg" src="https://pic-go-img.oss-cn-hangzhou.aliyuncs.com/202202230023069.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="开源项目 Tengbin_ACM 企业级中央配置引擎"></a></div><div class="recent-post-info"><a class="article-title" href="/2023/07/26/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%20Tengbin_ACM%20%E4%BC%81%E4%B8%9A%E7%BA%A7%E4%B8%AD%E5%A4%AE%E9%85%8D%E7%BD%AE%E5%BC%95%E6%93%8E/" title="开源项目 Tengbin_ACM 企业级中央配置引擎">开源项目 Tengbin_ACM 企业级中央配置引擎</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-07-26T03:08:40.000Z" title="发表于 2023-07-26 11:08:40">2023-07-26</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-comments"></i><a class="twikoo-count" href="/2023/07/26/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%20Tengbin_ACM%20%E4%BC%81%E4%B8%9A%E7%BA%A7%E4%B8%AD%E5%A4%AE%E9%85%8D%E7%BD%AE%E5%BC%95%E6%93%8E/#post-comment"><i class="fa-solid fa-spinner fa-spin"></i></a><span class="article-meta-label"> 条评论</span></span></div><div class="content">
本项目是适用于在企业中一同管理多个项目配置信息的中央配置引擎。

项目亮点用于统一管理项目中各种配置的平台，是互联网项目开发中必不可少的部分。由于它的存在，可以让我们在开发中减少因配置更新迭代而产生的大量代码。同时，针对成熟的技术从而实现配置热部署，当我们的配置发生变化时，无须停止服务，实现配置的更新。
采用 SpringBoot + SpringCloud 环境搭建，结合微服务项目引入应用。项目中使用了 Redis + FastDFS 作为缓存和容灾的解决方案。在推送配置时，采用了较流行的推和拉两种模式来实现。并且把配置中心中推送轨迹的功能也加入了进来。
配置中心作用动态加载配置？
多环境配置？
微服务架构统一管理配置？
配置更新轨迹？
当前市场上配置中心解决方案介绍Spring Cloud Config？
Ctrip Apollo？
Alibaba Nacos？
阿里云-ACM服务？
常用配置中心差异？
配置中心技术解决方案分析想实现自定义配置中心，有哪些潜在问题呢？或者说从方面考虑呢？

配置中心的数据如何接入
配置中心的存储如何落盘
配置中心的配置更新后如何动态推送
业务微服 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2023/07/07/Drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89/" title="Drools规则引擎原理及实战（一）"><img class="post-bg" src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/drools.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Drools规则引擎原理及实战（一）"></a></div><div class="recent-post-info"><a class="article-title" href="/2023/07/07/Drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89/" title="Drools规则引擎原理及实战（一）">Drools规则引擎原理及实战（一）</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-07-07T03:27:57.000Z" title="发表于 2023-07-07 11:27:57">2023-07-07</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E4%BC%81%E4%B8%9A%E5%BA%94%E7%94%A8%E7%AF%87/">企业应用篇</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/">规则引擎</a></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-comments"></i><a class="twikoo-count" href="/2023/07/07/Drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89/#post-comment"><i class="fa-solid fa-spinner fa-spin"></i></a><span class="article-meta-label"> 条评论</span></span></div><div class="content">问题引出现有一个在线申请信用卡的业务场景，用户需要录入个人信息，如下图所示：

通过上图可以看到，用户录入的个人信息包括姓名、性别、年龄、学历、电话、所在公司、职位、月收入、是否有房、是否有车、是否有信用卡等。录入完成后点击申请按钮提交即可。
用户提交申请后，需要在系统的服务端进行用户信息合法性检查（是否有资格申请信用卡），只有通过合法性检查的用户才可以成功申请到信用卡（注意：不同用户有可能申请到的信用卡额度不同）。
检查用户信息合法性的规则如下：



规则编号
名称
描述



1
检查学历与薪水1
如果申请人既没房也没车，同时学历为大专以下，并且月薪少于5000，那么不通过


2
检查学历与薪水2
如果申请人既没房也没车，同时学历为大专或本科，并且月薪少于3000，那么不通过


3
检查学历与薪水3
如果申请人既没房也没车，同时学历为本科以上，并且月薪少于2000，同时之前没有信用卡的，那么不通过


4
检查申请人已有的信用卡数量
如果申请人现有的信用卡数量大于10，那么不通过


用户信息合法性检查通过后，还需要根据如下信用卡发放规则确定用户所办信用卡的额度：



规则 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2023/07/05/RocketMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/" title="RocketMQ深度解析（上）"><img class="post-bg" src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/MQ%2Frocket-cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RocketMQ深度解析（上）"></a></div><div class="recent-post-info"><a class="article-title" href="/2023/07/05/RocketMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/" title="RocketMQ深度解析（上）">RocketMQ深度解析（上）</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-07-05T01:36:58.000Z" title="发表于 2023-07-05 09:36:58">2023-07-05</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AF%87/">中间件篇</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">源码学习</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-comments"></i><a class="twikoo-count" href="/2023/07/05/RocketMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/#post-comment"><i class="fa-solid fa-spinner fa-spin"></i></a><span class="article-meta-label"> 条评论</span></span></div><div class="content">RocketMQ 介绍RocketMQ 作为一款纯 java、分布式、队列模型的开源消息中间件，支持事务消息、顺序消息、批量消息、延时消息、消息回溯等。前身是 MetaQ，是阿里研发的一个队列模型的消息中间件，后开源给 apache 基金会成为了 apache 的顶级开源项目，具有高性能、高可靠、高实时、分布式特点。
RocketMQ 特点
支持发布&#x2F;订阅和点对点消息模型
在一个队列中可靠的先进先出（FIFO）和严格的顺序传递：RocketMQ 默认是多线程处理消息，如果要保证严格按照顺序传递，则需要将多线程改为单线程
支持拉（pull）和推（push）两种消息模式：拉模式在旧版本支持，现在新版本在慢慢的不推荐拉模式
单一队列百万消息的堆积能力（RocketMQ 提供亿级消息的堆积能力，重点是堆积了亿级的消息后，依然保持写入低延迟），而且现在是推模式，只要消费端不是特别慢，RocketMQ 是不会有什么问题的
支持多种消息协议，如 JMS、MQTT 等
分布式高可用的部署架构，满足至少一次消息传递语义
提供 docker 镜像用于隔离测试和云集群部署
提供配置、指标和监控等功 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8B%EF%BC%89/" title="RabbitMQ深度解析（下）"><img class="post-bg" src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/Header_Post_RabbitMQ_ES-3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RabbitMQ深度解析（下）"></a></div><div class="recent-post-info"><a class="article-title" href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8B%EF%BC%89/" title="RabbitMQ深度解析（下）">RabbitMQ深度解析（下）</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-07-04T12:53:48.000Z" title="发表于 2023-07-04 20:53:48">2023-07-04</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AF%87/">中间件篇</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">源码学习</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-comments"></i><a class="twikoo-count" href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8B%EF%BC%89/#post-comment"><i class="fa-solid fa-spinner fa-spin"></i></a><span class="article-meta-label"> 条评论</span></span></div><div class="content">延时任务什么是延时任务延时任务不是定时任务，需有前置条件。比如生成订单30min未支付，则自动取消。前置条件是下单。定时任务则不需要有前置条件，到点或按频率执行就行。
和定时任务的区别
定时任务有明确的触发时间，延时任务没有
定时任务有执行周期，而延时任务在某事件触发后一段时间内执行，没有执行周期
定时任务一般执行的是批处理操作是多个任务，而延时任务一般是单个任务

延时队列使用场景
订单在十分钟之内未支付则自动取消
账单在一周内未支付，则自动结算
用户注册成功后，如果没有修改初始密码进行提醒
用户发起退款，如果三天内没有得到处理则通知相关运营人员
预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会议
等

规范建议：数据库中如果时间字段经常排序、查询操作建议存 long 值，效率更快。原因是2023-09-01这种在查询和排序时，数据库也是转为 long 值后再进行操作。
常见方案数据库轮询（定时思想）该方案通常是在小型项目中使用，即通过一个线程定时的去扫描数据库，通过订单时间来判断是否有超时的订单，然后进行 update 或 delete 等操作。优点：简单易行，支持集群 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/" title="RabbitMQ深度解析（上）"><img class="post-bg" src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/Header_Post_RabbitMQ_ES-3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RabbitMQ深度解析（上）"></a></div><div class="recent-post-info"><a class="article-title" href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/" title="RabbitMQ深度解析（上）">RabbitMQ深度解析（上）</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-07-04T12:32:28.000Z" title="发表于 2023-07-04 20:32:28">2023-07-04</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AF%87/">中间件篇</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">源码学习</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-comments"></i><a class="twikoo-count" href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/#post-comment"><i class="fa-solid fa-spinner fa-spin"></i></a><span class="article-meta-label"> 条评论</span></span></div><div class="content">消息中间件（MQ）消息队列回顾
消息队列中间件是分布式系统中重要的组件，主要解决应用解耦，异步消息，流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构

目前使用较多的消息队列有 ActiveMQ，RabbitMQ，ZeroMQ，Kafka，MetaMQ，RocketMQ，消息中间件到底该如何使用，何时使用这是一个问题，胡乱地使用消息中间件增加了系统的复杂度，如果用不好消息中间件还不如不用。消息中间件利用高效可靠的消息传递机制进行平台无关的数据交流，并基于数据通信来进行分布式系统的集成，通过提供消息传递和消息排队模型，它可以在分布式环境下扩展进程间的通信，对于消息中间件，常见的角色大致也就有Producer（生产者）、Consumer（消费者）。
消息队列特点
先进先出：先进先出是队列的一个特性，数据是只有一条数据在使用中。
订阅：一般是 MQ 的广播模式，类似于 Java 的观察者模式，发布订阅是一种高效的处理方式，如果不发生阻塞，基本可以当作是同步操作。
持久化：MQ 能像数据库一样存储核心的数据。
分布式：在现在大流量、大数据的使用场景下，只支持单体应用的服务器软件基本是 ...</div></div></div><div class="recent-post-item"><div class="post_cover right"><a href="/2023/07/04/tomcat%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="tomcat源码剖析（更新中）"><img class="post-bg" src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/apache_tomcat-1024x415.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="tomcat源码剖析（更新中）"></a></div><div class="recent-post-info"><a class="article-title" href="/2023/07/04/tomcat%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="tomcat源码剖析（更新中）">tomcat源码剖析（更新中）</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-07-04T03:26:42.000Z" title="发表于 2023-07-04 11:26:42">2023-07-04</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%BA%90%E7%A0%81%E7%AF%87/">源码篇</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">源码学习</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/tags/%E5%85%AB%E8%82%A1%E6%96%87/">八股文</a></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-comments"></i><a class="twikoo-count" href="/2023/07/04/tomcat%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/#post-comment"><i class="fa-solid fa-spinner fa-spin"></i></a><span class="article-meta-label"> 条评论</span></span></div><div class="content">Tomcat 整体架构剖析Tomcat 的核心能力
从上图中可以看出主要是，接收请求、调用业务类、回写响应。
如何统一开发者写的业务类？定规范，做抽象。例如 JAVA EE：javax.servlet.Servlet，该规范定义了开发者如何编写业务类处理 web 请求。
如此一来就可以得到如下图的功能设计

tomcat 功能

http 服务器功能：处理底层的网络通信，应用层协议解析等相关功能
Servlet 容器功能：Servlet 的管理、加载、调用等

Tomcat 核心功能流程总结

监听网络端口，接收客户端连接
接受网络连接请求，读取网络请求字节流
根据具体应用层协议（HTTP）解析字节流，最终生成标准的 ServletRequest 对象
调用 Servlet 容器，得到标准的 ServletResponse 数据
最终将 ServletResponse 数据转换成网络字节流
将响应字节流回写给浏览器

Tomcat 的整体架构-组件分析连接器 Connector 对外处理请求，涉及的关键要素：IO 模型（例如：NIO、NIO2、APR）；应用协议（http&#x2F;1 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2023/06/25/hello-world/" title="Hello World"><img class="post-bg" src="https://pic-go-img.oss-cn-hangzhou.aliyuncs.com/202202230023069.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hello World"></a></div><div class="recent-post-info"><a class="article-title" href="/2023/06/25/hello-world/" title="Hello World">Hello World</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-06-25T03:26:42.000Z" title="发表于 2023-06-25 11:26:42">2023-06-25</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-comments"></i><a class="twikoo-count" href="/2023/06/25/hello-world/#post-comment"><i class="fa-solid fa-spinner fa-spin"></i></a><span class="article-meta-label"> 条评论</span></span></div><div class="content">Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.
Quick StartCreate a new post1$ hexo new &quot;My New Post&quot;

More info: Writing
Run server1$ hexo server

More info: Server
Generate static files1$ hexo generate

More info: Generating
Deploy to remote sites1$ hexo deploy

More info: Deployment
</div></div></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/02043070889f024eeb02a51c42658b9.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Tengbin Li</div><div class="author-info__description">大鹏一日同风起，扶摇直上九万里</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/bicycle-808" target="_blank" title="Github"><i class="fab fa-github" style="color: ;"></i></a><a class="social-icon" href="mailto:745075779@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: ;"></i></a><a class="social-icon" href="https://www.litengbin.com/static/wechat.jpg" target="_blank" title="微信"><i class="fab fa-weixin" style="color: ;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">最近会陆续将其他地方的文章迁移到本站中，更新频率视加班情况而定~🤣</div></div><div class="xpand" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div><script src="https://npm.elemecdn.com/ethan4116-blog/lib/js/other/two-people/twopeople1.js"></script><script src="https://npm.elemecdn.com/ethan4116-blog/lib/js/other/two-people/zdog.dist.js"></script><script id="rendered-js" src="https://npm.elemecdn.com/ethan4116-blog/lib/js/other/two-people/twopeople.js"></script><style>.card-widget.card-announcement {
margin: 0;
align-items: center;
justify-content: center;
text-align: center;
}
canvas {
display: block;
margin: 0 auto;
cursor: move;
}</style><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/07/26/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%20Tengbin_ACM%20%E4%BC%81%E4%B8%9A%E7%BA%A7%E4%B8%AD%E5%A4%AE%E9%85%8D%E7%BD%AE%E5%BC%95%E6%93%8E/" title="开源项目 Tengbin_ACM 企业级中央配置引擎"><img src="https://pic-go-img.oss-cn-hangzhou.aliyuncs.com/202202230023069.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="开源项目 Tengbin_ACM 企业级中央配置引擎"/></a><div class="content"><a class="title" href="/2023/07/26/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%20Tengbin_ACM%20%E4%BC%81%E4%B8%9A%E7%BA%A7%E4%B8%AD%E5%A4%AE%E9%85%8D%E7%BD%AE%E5%BC%95%E6%93%8E/" title="开源项目 Tengbin_ACM 企业级中央配置引擎">开源项目 Tengbin_ACM 企业级中央配置引擎</a><time datetime="2023-07-26T03:08:40.000Z" title="发表于 2023-07-26 11:08:40">2023-07-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/07/Drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89/" title="Drools规则引擎原理及实战（一）"><img src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/drools.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Drools规则引擎原理及实战（一）"/></a><div class="content"><a class="title" href="/2023/07/07/Drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E6%88%98%EF%BC%88%E4%B8%80%EF%BC%89/" title="Drools规则引擎原理及实战（一）">Drools规则引擎原理及实战（一）</a><time datetime="2023-07-07T03:27:57.000Z" title="发表于 2023-07-07 11:27:57">2023-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/05/RocketMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/" title="RocketMQ深度解析（上）"><img src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/MQ%2Frocket-cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RocketMQ深度解析（上）"/></a><div class="content"><a class="title" href="/2023/07/05/RocketMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/" title="RocketMQ深度解析（上）">RocketMQ深度解析（上）</a><time datetime="2023-07-05T01:36:58.000Z" title="发表于 2023-07-05 09:36:58">2023-07-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8B%EF%BC%89/" title="RabbitMQ深度解析（下）"><img src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/Header_Post_RabbitMQ_ES-3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RabbitMQ深度解析（下）"/></a><div class="content"><a class="title" href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8B%EF%BC%89/" title="RabbitMQ深度解析（下）">RabbitMQ深度解析（下）</a><time datetime="2023-07-04T12:53:48.000Z" title="发表于 2023-07-04 20:53:48">2023-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/" title="RabbitMQ深度解析（上）"><img src="https://bicycle808-blogs-1312817409.cos.ap-beijing.myqcloud.com/Header_Post_RabbitMQ_ES-3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RabbitMQ深度解析（上）"/></a><div class="content"><a class="title" href="/2023/07/04/RabbitMQ%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%8A%EF%BC%89/" title="RabbitMQ深度解析（上）">RabbitMQ深度解析（上）</a><time datetime="2023-07-04T12:32:28.000Z" title="发表于 2023-07-04 20:32:28">2023-07-04</time></div></div></div></div><div class="card-widget" id="card-newest-comments"><div class="item-headline"><i class="fas fa-comment-dots"></i><span>最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AF%87/"><span class="card-category-list-name">中间件篇</span><span class="card-category-list-count">3</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E4%BC%81%E4%B8%9A%E5%BA%94%E7%94%A8%E7%AF%87/"><span class="card-category-list-name">企业应用篇</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E6%BA%90%E7%A0%81%E7%AF%87/"><span class="card-category-list-name">源码篇</span><span class="card-category-list-count">1</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 1.45em; color: rgb(163, 198, 15)">后端开发</a><a href="/tags/%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/" style="font-size: 1.15em; color: rgb(155, 143, 0)">规则引擎</a><a href="/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" style="font-size: 1.35em; color: rgb(52, 186, 90)">源码学习</a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 1.25em; color: rgb(3, 11, 191)">消息队列</a><a href="/tags/%E5%85%AB%E8%82%A1%E6%96%87/" style="font-size: 1.15em; color: rgb(116, 132, 127)">八股文</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">七月 2023</span><span class="card-archive-list-count">6</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/06/"><span class="card-archive-list-date">六月 2023</span><span class="card-archive-list-count">1</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">7</div></div><div class="webinfo-item"><div class="item-name">已运行时间 :</div><div class="item-count" id="runtimeshow" data-publishDate="2022-12-31T16:00:00.000Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站总字数 :</div><div class="item-count">20k</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2023-08-23T07:04:17.195Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Tengbin Li</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => { 
  const getCommentUrl = () => {
    const eleGroup = document.querySelectorAll('#recent-posts .article-title')
    let urlArray = []
    eleGroup.forEach(i=>{
      urlArray.push(i.getAttribute('href'))
    })
    return urlArray
  }

  const getCount = () => {
    const runTwikoo = () => {
      twikoo.getCommentsCount({
        envId: 'https://blog.litengbin.com/',
        region: 'ap-shanghai',
        urls: getCommentUrl(),
        includeReply: false
      }).then(function (res) {
        document.querySelectorAll('#recent-posts .twikoo-count').forEach((item,index) => {
          item.textContent = res[index].count
        })
      }).catch(function (err) {
        console.log(err)
      })
    }

      if (typeof twikoo === 'object') {
        runTwikoo()
      } else {
        getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runTwikoo)
      }
  }

  window.pjax ? getCount() : window.addEventListener('load', getCount)

})()</script><script>window.typedJSFn = {
  init: (str) => {
    window.typed = new Typed('#subtitle', Object.assign({
      strings: str,
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50,
    }, null))
  },
  run: (subtitleType) => {
    if (true) {
      if (typeof Typed === 'function') {
        subtitleType()
      } else {
        getScript('https://cdn.jsdelivr.net/npm/typed.js/dist/typed.umd.min.js').then(subtitleType)
      }
    } else {
      subtitleType()
    }
  }
}
</script><script>function subtitleType () {
  getScript('https://sdk.jinrishici.com/v2/browser/jinrishici.js').then(() => {
    jinrishici.load(result =>{
      if (true) {
        const sub = []
        const content = result.data.content
        sub.unshift(content)
        typedJSFn.init(sub)
      } else {
        document.getElementById('subtitle').textContent = result.data.content
      }
    })
  })
}
typedJSFn.run(subtitleType)
</script></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://blog.litengbin.com/',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script src="/js/my.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>